---
- hosts: all
  vars:
    - provision_password: '$6$jIrFfxASDby3HBo9$jVw02IOyoqe0gmOUxmnn.QL99hIjsxsNPkehIqJc903iRU6CKYPLHEieI0Ij9Yp291bZOp4b2krZSYSsfxPur/'
    - pub_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64393530646261616336366463363064356137336565633334316363346465386230323335303464
          6363343864303962333361336138663164393536626532650a336531653062616264343938363466
          32666436623633313337663065666535323836613830363030653364313631326235363835363632
          3966643835373665320a303761373565333632363661306235373234633963633933383638623139
          65356238646137306333346636323562363232306437376139303434383830386133306233303464
          61376265633232613432663737393862636631363335363939626237393938303665306631313463
          31356533323632396533633435663766366631366135373565306134393031653361663831363038
          66373439366661393162366438633963386532376533613065323737623161613765373438633739
          37666137336136303464663063376265363537363934656530373836363364393764303266333338
          63613637303032616633663934376630393436333339613333666264306534666339613137333864
          38653331646465316535373732316637376538346136383635393537353861613434666362643364
          65626164376534646364633463353632383830316262346462336532376664303930353866626230
          36626462313562356436326566643665643266353966643638613861326138313862333331636664
          38616435336232666530333865633936633463326630656534623630343335343130303161663233
          64303139303565356635653061306666396366306161383038316162373764643931343731636337
          35373231363937666163333164363666366439666561656266393334313635653261356162613730
          61383032653533306533393463396538336263323338303663666461393664663834646639613736
          39656131316665366436306565396335663765376238343566336163373636323564303333396464
          30336532653838626336323838323737363631363030663230363933353832363762373932386264
          30323531313138323962313934393533626437383335396664343438343561343833373434353261
          37376234393031353137323031363637353066663833383635656639653130323138623764373366
          30386637386265306531323435386630616536663737383065386233666436396236326265346666
          35323466363163666535336532343333393335306138616662323665323937366333626136323361
          61336565613362616230306238643766356532313464633036386431323761383939616635316431
          65316261376431653062303838313131616562383966343831333433383735616261623636643162
          34376661616264356130373064336231633261643435626464666538306261333231333463333332
          64646331303964666563366330303233396137353736623139626438306238663236313363616137
          31613165616163343233643764646133323463313431326166353437366438343464386433366362
          64323065353136373737383230646138623034633236376464323739353164646665643464376365
          32633161663665616530313232626565383462363738313736656364393934366263306234303439
          31356439356432353037363261623165343763633466316230313230626539333639323763356630
          38363639653664356330326638366534386536376235653338346166323730313633633836333963
          64313865363538373664653862626566333661393935373935333632656265333866
    - rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr
    - ansible_sudo_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36396630656166353466653630643839366265376635646333356166303436633935396632626465
          3561366639646365333733653036363835316465373733630a643765316663346133306362396466
          38343631643331383039613063663434396137316363666363373766316238303337633833663630
          3331396431373631300a356533636666636235313432333034376162393334343861303364363566
          6533
    - certbot_auto_renew_user: xiguazhi
    - certbot_auto_renew_minute: "20"
    - certbot_auto_renew_hour: "5"
  gather_facts: yes
  remote_user: svc-tf-dev
  become: true
  roles:
    - geerlingguy.certbot
  tasks:
  - name: Add a new user named provision
    user:
      name: "{{ ans_usr }}"
      shell: /bin/bash
      password: "{{ provision_password }}"

  - name: Add provision user to the sudoers.
    copy:
      dest: "/etc/sudoers.d/provision"
      content: "provision   ALL=(ALL)   NOPASSWD: ALL"

  - name: Create Directory
    file:
      path: "/home/{{ ans_usr }}/.ssh"
      state: directory
  - name: Create empty file
    file:
      path: "/home/{{ ans_usr }}/.ssh/authorized_keys"
      state: touch
  - name: put pubkey
    lineinfile:
      path: "/home/{{ ans_usr }}/.ssh/authorized_keys"
      line: "{{ pub_key }}"
  - name: Disable Password Authentication
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PasswordAuthentication'
      line: "PasswordAuthentication no"
      state: present
      backup: yes
  - name: Disable Root Login
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PermitRootLogin'
      line: "PermitRootLogin no"
      state: present
      backup: yes
    notify:
    - restart ssh
  handlers:
    - name: restart ssh
      service:
        name: sshd
        state: restarted
