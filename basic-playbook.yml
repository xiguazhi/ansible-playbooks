---
- hosts: all
  vars:
    provision_password: '$6$jIrFfxASDby3HBo9$jVw02IOyoqe0gmOUxmnn.QL99hIjsxsNPkehIqJc903iRU6CKYPLHEieI0Ij9Yp291bZOp4b2krZSYSsfxPur/'
    pub_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36326131393063616466306266376635386231656264636565633461333163616261613332346361
          6634396238373761636666396230653036653834303732610a616537663738633065343237393966
          30376338326662636232396334373363353763393431363339653065346365343639666232613566
          3732663131633836300a323933613866343838646365653938633039336132383466653230386435
          37633466363434666136616633376638633861646439303030373330353937356236626230313064
          34633531653938313962343635303231303236336461613966333464386436323166353933613133
          65303262643264666630353161663964303431346234646430303436633339326637323865613065
          37636261613238356238386665636636336532613933323364633833353065316362353833333264
          38643764636663376666313336386230363266356331613564633236353432653431663464663063
          38363730653766383939616638663264383435303662373764386461363437616230333738616464
          66643238323961636262306235613862333562363231353633633966633166346637633338323862
          30636661393163323030373163646166383239356636656662343063616261356230313433613062
          66656436373037306539663964313737303863346337643765356535393235623863343934396535
          36393831363833626465646334363833356337653933636630633335653535353632316638616463
          64666631323463356437383661366561373439616135616665353133356663303865303137353036
          30653539333865326161356436643263303331323561393863643438616566376530346664626131
          62386231323334346638393963313339643035653966343334393463613033313438626165386162
          65386439363963326335383732353761373965646532626362336264333735633036636436383063
          34656331643865363734613830363437386263633232353465333133326463633334326634646438
          64613037383630316636373831666535363164636334333061393365396130386464356435306237
          61653066656639646637333164393334386666303834663434613239663164313335373732623835
          35646636313631383834306430626162366131363438623339393966623538386636343338306633
          64323365336235323935336335633962313764376139653033643262393231646366323365323234
          30393930616637323164333766393361643032323730376439373639663837323837346465373932
          38363262643732393239396339316263633637346465613534333131313961353935623166383536
          37623833396432666262373632393262383137306566333264636364393836386661646430366361
          63386334383932383734336166666531343039346563363434306364326561376661643231336335
          33653836393535336231353239366565396438386333646166336634663136633035353237323465
          62643666636631366636646336656533653037363765326337616439633434326536623730383766
          35383965656564633939356462306338336239303065333964653735323832353934383434393136
          31383536616537383964616261663864666630616231666166616163386633326335623133663866
          38613966313937663631613534363138353731633139633663356363303732353035663736616366
          39643631376666623039633536303132653634383730386636613565346330396164
    ansible_sudo_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65613737396533616264316263643935326130346462353339313566623833363466616235623535
          6237356332613664333835353731363334613132663731640a333836366434663936346162636335
          36613430303536396538313433663531303362633232303731663064653531333331376366616134
          3362303039326330330a643134616465666136626130633631383063383663623961636638353330
          3538
    certbot_auto_renew_user: xiguazhi
    certbot_auto_renew_minute: "20"
    certbot_auto_renew_hour: "5"
  gather_facts: yes
  ansible_user: svc-tf-dev
  become: true
  roles:
    - geerlingguy.certbot
  tasks:
  - name: Add a new user named provision
    user:
      name: "{{ ans_usr }}"
      shell: /bin/bash
      password: "{{ provision_password }}"

  - name: Add provision user to the sudoers.
    copy:
      dest: "/etc/sudoers.d/provision"
      content: "provision   ALL=(ALL)   NOPASSWD: ALL"

  - name: Create Directory
    file:
      path: "/home/{{ ans_usr }}/.ssh"
      state: directory
  - name: Create empty file
    file:
      path: "/home/{{ ans_usr }}/.ssh/authorized_keys"
      state: touch
  - name: put pubkey
    lineinfile:
      path: "/home/{{ ans_usr }}/.ssh/authorized_keys"
      line: "{{ pub_key }}"
  - name: Disable Password Authentication
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PasswordAuthentication'
      line: "PasswordAuthentication no"
      state: present
      backup: yes
  - name: Disable Root Login
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PermitRootLogin'
      line: "PermitRootLogin no"
      state: present
      backup: yes
    notify:
    - restart ssh
  handlers:
    - name: restart ssh
      service:
        name: sshd
        state: restarted
